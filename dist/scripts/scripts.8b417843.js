"use strict";function generateGraph(a,b){calcShopBudgets(a,b);var c=450;a.budgets=[{budgetname:"ShopBudget",color:"#f1b62d",amount:a.shop.shopbudget},{budgetname:"Amended Budget",color:"#b44322",amount:a.shop.amendedbudget?a.shop.amendedbudget:0},{budgetname:"Amount Utilized",color:"#72ba22",amount:a.shop.utilizedbudget}];var d=Math.max(a.budgets[0].amount,a.budgets[1].amount,a.budgets[2].amount);a.budgets[0].width=c/d*a.budgets[0].amount,a.budgets[1].width=c/d*a.budgets[1].amount,a.budgets[2].width=c/d*a.budgets[2].amount,a.utilisationTitle="%Utilization",a.utilisation={percent:a.budgets[2].amount<=0?0:100/a.budgets[1].amount*a.budgets[2].amount}}function loadShopData(a,b,c,d,e){c.getHeads().success(function(c){c&&c.results&&(a.heads=c.results.filter(function(a){var c=moment(a.createdTimestamp,"DD-MM-YYYY"),d=c.year();return c.month()+1>=b.startoftheyear&&a.year==d?a:c.month()+1<b.startoftheyear&&a.year+1==d?a:""}),d.getRequitisions().success(function(c){c&&c.results&&(a.requisitions=c.results,e.getPO().success(function(c){if(c&&c.results){a.po=c.results;for(var d=0;d<a.requisitions.length;d++){a.requisitions[d].po=[];for(var e=0;e<a.po.length;e++)a.requisitions[d]._id==a.po[e].requsitionid&&a.requisitions[d].po.push(a.po[e])}}for(var f=0;f<a.heads.length;f++){a.heads[f].requisitions=[],a.heads[f].amountutilized=0,a.heads[f].amendedbudget=a.heads[f].amendedbudget||0==a.heads[f].amendedbudget?a.heads[f].amendedbudget:a.heads[f].budget;for(var g=0;g<a.requisitions.length;g++){a.heads[f]._id==a.requisitions[g].headid&&a.heads[f].requisitions.push(a.requisitions[g]);for(var d=0;d<a.po.length;d++)a.heads[f]._id==a.requisitions[g].headid&&a.po[d].requsitionid==a.requisitions[g]._id&&(a.heads[f].amountutilized=parseFloat(a.heads[f].amountutilized)+parseFloat(a.po[d].amount))}}generateGraph(a,b)})),b.requisitions=a.requisitions}),b.heads=a.heads)})}function calcShopBudgets(a,b){for(var c=0;c<b.shops.length;c++){b.shops[c].amendedbudget=0,b.shops[c].utilizedbudget=0;for(var d=0;d<a.heads.length;d++)b.shops[c]._id==a.heads[d].shopid&&(b.shops[c].amendedbudget=parseFloat(b.shops[c].amendedbudget)+(a.heads[d].amendedbudget&&"."!=a.heads[d].amendedbudget?parseFloat(a.heads[d].amendedbudget):0),b.shops[c].utilizedbudget=parseFloat(b.shops[c].utilizedbudget)+parseFloat(a.heads[d].amountutilized));a.shop._id==b.shops[c]._id&&(a.shop=b.shops[c])}}angular.module("budgetTrackingApp",["ngAnimate","ngSanitize","ngRoute","ngDialog","720kb.datepicker"]);var app=angular.module("budgetTrackingApp");app.constant("entribServices",{queryParams:"?customerid=1&userid=1",shopURL:"http://jira.entrib.com/server/elements/shop/records",headURL:"http://jira.entrib.com/server/elements/head/records",requisitionURL:"http://jira.entrib.com/server/elements/requisition/records",poURL:"http://jira.entrib.com/server/elements/po/records",yearURL:"http://jira.entrib.com/server/elements/financialyear/records"}),angular.module("budgetTrackingApp").config(["$routeProvider",function(a){a.when("/home",{templateUrl:"shopSummary.html",controller:"ShopCtrl"}).when("/requisition",{templateUrl:"requisition.html",controller:"RequisitionCtrl"}).otherwise({redirectTo:"/home"})}]),angular.module("budgetTrackingApp").controller("ShopCtrl",["$scope","$rootScope","ShopService","$location",function(a,b,c,d){b.$on("showMenu",function(b,c){a.openMenu=c}),a.openMenu=b.openMenu,a.getShops=function(){c.getShops().success(function(c){c&&c.results&&(a.shops=c.results,a.shops.forEach(function(a){a.shopbudget||(a.shopbudget=0)}),b.shops=a.shops,b.selectedShopForNav||(a.selectedShopForNav=a.shops[0],b.selectedShopForNav=a.selectedShopForNav),b.$emit("shopselected",a.selectedShopForNav))}).error(function(a,c){b.handleError(a,c)})["catch"](function(a){b.handleError(null,null,a)})},a.getShops(),a.selectShop=function(c){a.selectedShopForNav=c,b.selectedShopForNav=a.selectedShopForNav,b.$emit("shopselected",a.selectedShopForNav),d.path("home")}}]),angular.module("budgetTrackingApp").controller("MainCtrl",["$scope","$rootScope","HeadService","RequisitionService","POService","ngDialog","YearService","$timeout",function(a,b,c,d,e,f,g,h){b.checkNumber=function(a){return void 0==a||null==a||0>a||""==a?!1:!0},b.handleError=function(a,c,d){b.showNetworkError=!0,h(function(){b.showNetworkError=!1},3500)},b.$on("shopselected",function(f,h){document.getElementById("main").scrollTop=0,b.openMenu=!1,b.$emit("showMenu",b.openMenu),a.shop=h,b.heads?generateGraph(a,b):g.getYear().success(function(f){b.startoftheyear=f.results[0].startoftheyear,loadShopData(a,b,c,d,e)}).error(function(a,c){b.handleError(a,c)})["catch"](function(a){b.handleError(null,null,a)})}),a.updateBudgetHead=function(d,e){13==d&&b.checkNumber(e.amendedbudget)&&(e.isupdating=!0,c.updateHead(e._id,{amendedbudget:e.amendedbudget}).success(function(){e.isupdating=!1,generateGraph(a,b)}).error(function(a,c){e.isupdating=!1,b.handleError(a,c)})["catch"](function(a){e.isupdating=!1,b.handleError(null,null,a)})),generateGraph(a,b)},a.approveRequisition=function(a){a.isupdating=!0,d.updateRequitision(a._id,{isapproved:a.isapproved}).success(function(){a.isupdating=!1}).error(function(c,d){a.isupdating=!1,b.handleError(c,d)})["catch"](function(c){a.isupdating=!1,b.handleError(null,null,c)})},a.openHead=function(c){a.activeHead==c?a.activeHead=void 0:(a.activeHead=c,b.activeHead=a.activeHead)},a.createHead=function(){a.newhead={shopid:a.shop._id},a.createHeadDialog=f.open({template:"createHead.html",className:"ngdialog-theme-default",scope:a,closeByDocument:!1})},a.saveHead=function(){a.newhead.headname&&b.checkNumber(a.newhead.budget)&&a.newhead.headcode&&a.newhead.remarks?(a.isHeadSaving=!0,c.saveHead(a.newhead).success(function(){a.isHeadSaving=!1,loadShopData(a,b,c,d,e),f.close(a.createHeadDialog)}).error(function(c,d){a.isHeadSaving=!1,b.handleError(c,d)})["catch"](function(c){a.isHeadSaving=!1,b.handleError(null,null,c)})):f.open({template:'<p class="no-data">All fields are Mandatory to create a new head</p>',plain:!0})},a.groupBudget=function(){a.totalBudget=0,a.totalAmendedBudget=0,a.totalUtilizedBudget=0;for(var c=0;c<b.shops.length;c++)a.totalBudget=parseFloat(a.totalBudget)+parseFloat(b.shops[c].shopbudget),a.totalAmendedBudget=parseFloat(a.totalAmendedBudget)+parseFloat(b.shops[c].amendedbudget),a.totalUtilizedBudget=parseFloat(a.totalUtilizedBudget)+parseFloat(b.shops[c].utilizedbudget);f.open({template:"groupBudget.html",className:"ngdialog-theme-default",scope:a,width:"60%"})},b.getCurrentFinYear=function(){return b.startoftheyear<=moment().month()+1?1==b.startoftheyear?moment().year():(moment().year()+"").substring(2)+(parseInt((moment().year()+"").substring(2))+1):parseInt((moment().year()+"").substring(2))-1+(moment().year()+"").substring(2)},a.createPo=function(c){var d=1;for(a.po&&a.po.length>0&&(a.po.sort(function(a,b){return parseInt(_.last(a.ponumber.split("/")))<parseInt(_.last(b.ponumber.split("/")))?-1:1}),d=parseInt(_.last(_.last(a.po).ponumber.split("/")))+1+"");(d+"").length<3;)d="0"+d;a.requisitionPOAmount=0,c.po||(c.po=[]),c.po.forEach(function(b){a.requisitionPOAmount+=b.amount}),a.currentRequisition=c,a.newpo={requsitionid:c._id,ponumber:"PO/"+b.getCurrentFinYear()+"/"+d,date:(new Date).getDate()+"-"+((new Date).getMonth()+1)+"-"+(new Date).getFullYear()},a.createPoDialog=f.open({template:"createPO.html",className:"ngdialog-theme-default",scope:a,closeByDocument:!1})},a.savePO=function(){a.newpo.ponumber&&a.newpo.date&&b.checkNumber(a.newpo.amount)&&a.newpo.description?(a.isPOSaving=!0,e.savePO(a.newpo).success(function(){a.isPOSaving=!1,loadShopData(a,b,c,d,e),f.close(a.createPoDialog)}).error(function(c,d){a.isPOSaving=!1,b.handleError(c,d)})["catch"](function(c){a.isPOSaving=!1,b.handleError(null,null,c)})):f.open({template:'<p class="no-data">All fields are Mandatory to create a new po</p>',plain:!0})}}]),angular.module("budgetTrackingApp").controller("HeadCtrl",["$scope","$rootScope",function(a,b){a.user={id:"1",name:""},b.openMenu=!1,a.showMenu=function(){b.openMenu=!b.openMenu,b.$emit("showMenu",b.openMenu)}}]),angular.module("budgetTrackingApp").controller("RequisitionCtrl",["$scope","$rootScope","RequisitionService","$location","ngDialog",function(a,b,c,d,e){function f(){var c=!1;if(a.newrequisition.selectedsupplier==a.newrequisition.supplier1&&(a.newrequisition.amount=a.newrequisition.negotiatedcost1),a.newrequisition.selectedsupplier==a.newrequisition.supplier2&&(a.newrequisition.amount=a.newrequisition.negotiatedcost2),a.newrequisition.selectedsupplier==a.newrequisition.supplier3&&(a.newrequisition.amount=a.newrequisition.negotiatedcost3),a.newrequisition.supplier1){if(c=b.checkNumber(a.newrequisition.quotedcost1),!c)return!1;if(c=b.checkNumber(a.newrequisition.negotiatedcost1),!c)return!1}else{if(c=!b.checkNumber(a.newrequisition.quotedcost1),!c)return!1;if(c=!b.checkNumber(a.newrequisition.negotiatedcost1),!c)return!1}if(a.newrequisition.supplier2){if(c=b.checkNumber(a.newrequisition.quotedcost2),!c)return!1;if(c=b.checkNumber(a.newrequisition.negotiatedcost2),!c)return!1}else{if(c=!b.checkNumber(a.newrequisition.quotedcost2),!c)return!1;if(c=!b.checkNumber(a.newrequisition.negotiatedcost2),!c)return!1}if(a.newrequisition.supplier3){if(c=b.checkNumber(a.newrequisition.quotedcost3),!c)return!1;if(c=b.checkNumber(a.newrequisition.negotiatedcost3),!c)return!1}else{if(c=!b.checkNumber(a.newrequisition.quotedcost3),!c)return!1;if(c=!b.checkNumber(a.newrequisition.negotiatedcost3),!c)return!1}return a.suppliers&&a.suppliers.length>=2&&c?!0:!1}a.selectedShopForNav||d.path("home"),a.today=new Date,a.activeHead=b.activeHead,a.selectedShopForNav=b.selectedShopForNav,a.categories=["Productivity","Quality","Cost","Delivery","SHE","Replacement","Reconditioning","New Model","Introduction","Others"],a.heads=b.heads,a.quarters=[0,0,0,0],a.heads&&a.heads.forEach(function(c){c.shopid==a.selectedShopForNav._id&&c.requisitions&&c.requisitions.forEach(function(c){var d=moment(c.createdTimestamp,"DD-MM-YYYY").month()+1;d=d<b.startoftheyear?d+12:d;for(var e=b.startoftheyear,f=0;d>=e;)e+=3,f++;a.quarters[f-1]+=parseInt(c.amount)})}),a.requisitionnumberprefix=(a.selectedShopForNav.division?a.selectedShopForNav.division+"/":"")+(a.selectedShopForNav.shortname?a.selectedShopForNav.shortname+"/":"")+b.getCurrentFinYear(),a.getNextRequisitionNumber=function(){var a=1;if(b.requisitions&&b.requisitions.length>0)for(b.requisitions.sort(function(a,b){return parseInt(_.last(a.requisitionnumber.split("/")))<parseInt(_.last(b.requisitionnumber.split("/")))?-1:1}),a=parseInt(_.last(_.last(b.requisitions).requisitionnumber.split("/")))+1+"";a.length<3;)a="0"+a;return a},a.supplierChange=function(b){a.suppliers=[],a.suppliers.push(a.newrequisition.supplier1),a.suppliers.push(a.newrequisition.supplier2),a.suppliers.push(a.newrequisition.supplier3),a.suppliers=a.suppliers.filter(function(a){return a?!0:!1})},a.newrequisition={headid:a.activeHead._id,category:a.categories[0],shopname:a.selectedShopForNav.shopname,requisitionnumber:a.requisitionnumberprefix+"/"+a.getNextRequisitionNumber()},a.saveRequisition=function(){f();f()&&a.newrequisition.selectedsupplier&&a.newrequisition.reasonsuppliersection&&a.newrequisition.justification&&a.newrequisition.categorydetails&&a.newrequisition.category&&b.checkNumber(a.newrequisition.qty)&&a.newrequisition.description&&a.newrequisition.cell&&a.newrequisition.remarks?c.saveRequitision(a.newrequisition).success(function(){b.heads.forEach(function(b){b._id==a.newrequisition.headid&&(a.newrequisition.createdTimestamp=moment().date()+"-"+(moment().month()+1)+"-"+moment().year(),a.newrequisition.po=[],b.requisitions.push(a.newrequisition))}),b.heads=null,d.path("home")}).error(function(a,c){b.handleError(a,c)})["catch"](function(a){b.handleError(null,null,a)}):e.open({template:'<p class="no-data">All fields are Mandatory to create a new requisition</p>',plain:!0})}}]),angular.module("budgetTrackingApp").factory("ShopService",["$http","entribServices",function(a,b){return{getShops:function(){return a.get(b.shopURL+b.queryParams)}}}]),angular.module("budgetTrackingApp").factory("HeadService",["$http","entribServices",function(a,b){return{getHeads:function(){return a.get(b.headURL+b.queryParams)},updateHead:function(c,d){return a.put(b.headURL+"/"+c+b.queryParams,d)},saveHead:function(c){return c.newhead="true",c.siteName="abc",c.year=moment().year(),a.post(b.headURL+b.queryParams,c)}}}]),angular.module("budgetTrackingApp").factory("RequisitionService",["$http","entribServices",function(a,b){return{getRequitisions:function(){return a.get(b.requisitionURL+b.queryParams)},updateRequitision:function(c,d){return a.put(b.requisitionURL+"/"+c+b.queryParams,d)},saveRequitision:function(c){return c.siteName="abc",a.post(b.requisitionURL+b.queryParams,c)}}}]),angular.module("budgetTrackingApp").factory("POService",["$http","entribServices",function(a,b){return{getPO:function(){return a.get(b.poURL+b.queryParams)},savePO:function(c){return c.siteName="abc",a.post(b.poURL+b.queryParams,c)}}}]),angular.module("budgetTrackingApp").factory("YearService",["$http","entribServices",function(a,b){return{getYear:function(){return a.get(b.yearURL+b.queryParams)}}}]),angular.module("budgetTrackingApp").directive("budgetHead",function(){return{restrict:"E",templateUrl:"budgetHeadTemplate.html"}}),angular.module("budgetTrackingApp").directive("budgetRequisition",function(){return{restrict:"E",templateUrl:"budgetRequisitionTemplate.html"}}),angular.module("budgetTrackingApp").directive("budgetPo",function(){return{restrict:"E",templateUrl:"budgetPOTemplate.html"}}),angular.module("budgetTrackingApp").directive("maxLength",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){function e(a){var b=/^\d{0,9}$/,c=d.$modelValue;return b.test(a)?(d.$setViewValue(a),d.$render(),a):(d.$setViewValue(c),d.$render(),c)}d.$parsers.push(e)}}}),angular.module("budgetTrackingApp").filter("shop",function(){return function(a,b){for(var c=[],d=0;a&&d<a.length;d++)a[d].shopid==b&&c.push(a[d]);return c}}),angular.module("budgetTrackingApp").filter("length",function(){return function(a,b){if(b=parseInt(b),isNaN(a)||isNaN(b))return a;if(a.toString().length<b){for(var c=a.toString().length;b>c;c++)a="0"+a;return a}return a}});